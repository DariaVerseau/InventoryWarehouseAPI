<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Категории</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
<nav class="bg-green-800 text-white p-4">
    <div class="container mx-auto flex flex-wrap gap-4">
        <a href="dashboard.html" class="font-bold">Главная</a>
        <a href="warehouses.html">Склады</a>
        <a href="categories.html" class="underline">Категории</a>
    </div>
</nav>

<div class="container mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Список категорий</h1>
        <a href="category-create.html" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">+ Добавить</a>
    </div>

    <!-- Фильтры -->
    <div class="bg-white p-4 rounded shadow mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Поиск по названию</label>
                <input type="text" id="search" placeholder="Введите текст..." class="w-full p-2 border rounded" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Только видимые</label>
                <div class="flex items-center mt-1">
                    <input type="checkbox" id="visible-only" class="mr-2" />
                    <span>Да</span>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Сортировка</label>
                <select id="sort" class="w-full p-2 border rounded">
                    <option value="name">Название (А-Я)</option>
                    <option value="name desc">Название (Я-А)</option>
                    <option value="createdAt">Сначала старые</option>
                    <option value="createdAt desc">Сначала новые</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Таблица -->
    <div class="bg-white rounded shadow overflow-hidden">
        <table class="min-w-full divide-y">
            <thead class="bg-gray-100">
            <tr>
                <th class="px-6 py-3 text-left font-medium text-gray-700">Название</th>
                <th class="px-6 py-3 text-left font-medium text-gray-700">Описание</th>
                <th class="px-6 py-3 text-left font-medium text-gray-700">Видима</th>
                <th class="px-6 py-3 text-left font-medium text-gray-700">Действия</th>
            </tr>
            </thead>
            <tbody id="table-body" class="divide-y"></tbody>
        </table>
    </div>

    <!-- Пагинация -->
    <div id="pagination" class="mt-4 flex justify-center gap-2"></div>
</div>

<div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>

<script>
    const API = '/api';
    let page = 1, totalPages = 1;

    window.showToast = (msg, type = 'success') => {
        const c = { success: 'green', error: 'red', warning: 'yellow' };
        const el = document.createElement('div');
        el.className = `bg-${c[type]}-100 border-l-4 border-${c[type]}-500 text-${c[type]}-700 p-3 rounded`;
        el.innerHTML = `<p>${msg}</p>`;
        document.getElementById('toast-container').appendChild(el);
        setTimeout(() => el.remove(), 5000);
    };

    const load = async () => {
        const search = document.getElementById('search').value || '';
        const isVisible = document.getElementById('visible-only').checked ? 'true' : '';
        const sort = document.getElementById('sort').value || 'name';
        const url = `${API}/categories/filtered?search=${encodeURIComponent(search)}&isVisible=${isVisible}&sortBy=${sort}&page=${page}&pageSize=5`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            totalPages = data.totalPages;

            document.getElementById('table-body').innerHTML = data.items.map(c => `
          <tr>
            <td class="px-6 py-4 font-medium">${c.name}</td>
            <td class="px-6 py-4 text-gray-600">${c.description || '—'}</td>
            <td class="px-6 py-4">${c.isVisible ? '✅ Да' : '❌ Нет'}</td>
            <td class="px-6 py-4">
              <button onclick="del('${c.id}')" class="text-red-600 hover:underline text-sm">Удалить</button>
            </td>
          </tr>
        `).join('');

            let pg = '';
            for (let i = 1; i <= totalPages; i++) {
                pg += `<button onclick="goTo(${i})" class="px-3 py-1 border rounded ${i === page ? 'bg-green-600 text-white' : ''}">${i}</button>`;
            }
            document.getElementById('pagination').innerHTML = pg;
        } catch (e) {
            showToast('Ошибка загрузки категорий', 'error');
        }
    };

    const goTo = (p) => { page = p; load(); };
    const del = async (id) => {
        if (!confirm('Удалить категорию?')) return;
        try {
            await fetch(`${API}/categories/${id}`, { method: 'DELETE' });
            showToast('Категория удалена');
            load();
        } catch (e) {
            showToast('Не удалось удалить', 'error');
        }
    };

    document.getElementById('search').addEventListener('input', load);
    document.getElementById('visible-only').addEventListener('change', load);
    document.getElementById('sort').addEventListener('change', load);
    document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>